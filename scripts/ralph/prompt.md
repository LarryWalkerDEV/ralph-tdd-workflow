# Ralph TDD Loop - Fresh Window Instructions

You are in a FRESH context window for the Ralph TDD loop.
Your job: Make all tests pass by implementing code. You CANNOT modify tests.

---

## FIRST: Read Context Files

You just read:
1. **AGENTS.md** - Codebase patterns (apply these!)
2. **STATE.md** - Resume point (where to continue)
3. **This prompt** - Your instructions
4. **prd.json** - Stories to implement

**Identify:**
- Which story is next (from STATE.md resume point)
- What acceptance criteria must pass
- Any dependencies that block parallel work

---

## Available Subagents

| Subagent | Purpose | Restrictions |
|----------|---------|--------------|
| `tdd-test-scaffolder` | Write tests FIRST | Cannot edit src/ |
| `tdd-implementer` | Implement code to pass tests | Cannot edit tests (BLOCKED) |
| `playwright-test-validator` | Run Playwright tests | Read-only |
| `form-component-validator` | Browser visual checks | Read-only |

---

## TDD Workflow

```
┌─────────────────────────────────────────────────────────────────┐
│  PHASE 1: TEST WRITING (tests already exist, verify they fail) │
│  ├── Tests were generated by /ralph skill                       │
│  ├── Run: npx playwright test e2e/... --reporter=list          │
│  └── Confirm tests FAIL (no implementation exists)             │
│                                                                 │
│  PHASE 2: BUILDING (implement to make tests pass)              │
│  ├── Set phase: node .claude/hooks/ralph-guard.js set-phase build│
│  ├── Set story: node .claude/hooks/ralph-guard.js set-story US-001│
│  ├── Use: Task({ subagent_type: "tdd-implementer", ... })      │
│  ├── tdd-implementer CANNOT modify tests (hook BLOCKS)         │
│  └── Run tests until they pass                                 │
│                                                                 │
│  PHASE 3: VALIDATION (both validators in parallel)             │
│  ├── Set phase: node .claude/hooks/ralph-guard.js set-phase validate│
│  ├── Task(playwright-test-validator) - run actual tests        │
│  ├── Task(form-component-validator) - real browser checks      │
│  └── Both must PASS to proceed                                 │
│                                                                 │
│  PHASE 4: ITERATE OR COMMIT                                    │
│  ├── If ANY validator FAIL:                                    │
│  │   ├── Read failure details                                  │
│  │   ├── Return to PHASE 2                                     │
│  │   └── Fix code (NOT tests), re-validate                     │
│  ├── If ALL validators PASS:                                   │
│  │   ├── Create checkpoints                                    │
│  │   ├── Commit: git add -A && git commit                      │
│  │   └── Update prd.json: passes: true                         │
│  └── Loop to next story                                        │
└─────────────────────────────────────────────────────────────────┘
```

---

## Commands Reference

```bash
# Workflow control
node .claude/hooks/ralph-guard.js start          # Activate (already done)
node .claude/hooks/ralph-guard.js stop           # Deactivate when COMPLETE
node .claude/hooks/ralph-guard.js status         # Show current state

# Phase management
node .claude/hooks/ralph-guard.js set-phase test-write
node .claude/hooks/ralph-guard.js set-phase build
node .claude/hooks/ralph-guard.js set-phase validate
node .claude/hooks/ralph-guard.js set-phase commit

# Story tracking
node .claude/hooks/ralph-guard.js set-story US-001
node .claude/hooks/ralph-guard.js create-checkpoint tests_written PASS
node .claude/hooks/ralph-guard.js create-checkpoint build_complete PASS
node .claude/hooks/ralph-guard.js create-checkpoint playwright_validated PASS
node .claude/hooks/ralph-guard.js create-checkpoint browser_validated PASS
node .claude/hooks/ralph-guard.js clear-checkpoints
```

---

## Parallel Execution Rules

**MUST be parallel (single message, multiple Task calls):**

```javascript
// Independent stories - build in parallel
Task({ subagent_type: "tdd-implementer", description: "Build US-001", ... })
Task({ subagent_type: "tdd-implementer", description: "Build US-002", ... })

// Both validators per story - parallel
Task({ subagent_type: "playwright-test-validator", description: "Validate US-001", ... })
Task({ subagent_type: "form-component-validator", description: "Validate US-001", ... })
```

**MUST be sequential:**
- Stories with `depends_on` wait for dependencies
- Phases run in order (build → validate → commit)

---

## Iteration Loop

```javascript
for (const story of stories.filter(s => !s.passes)) {
  let attempts = 0;

  while (attempts < 5) {
    // Set context
    await Bash(`node .claude/hooks/ralph-guard.js set-story ${story.id}`);
    await Bash(`node .claude/hooks/ralph-guard.js set-phase build`);

    // Build (tdd-implementer cannot modify tests - hook enforced)
    await Task({ subagent_type: "tdd-implementer", ... });

    // Validate (both in parallel)
    await Bash(`node .claude/hooks/ralph-guard.js set-phase validate`);
    const [playwright, browser] = await Promise.all([
      Task({ subagent_type: "playwright-test-validator", ... }),
      Task({ subagent_type: "form-component-validator", ... })
    ]);

    // Check results
    if (playwright.verdict === "PASS" && browser.verdict === "PASS") {
      // Success - commit and mark complete
      await Bash(`node .claude/hooks/ralph-guard.js set-phase commit`);
      await Bash(`git add -A && git commit -m "feat(${story.id}): ${story.title}"`);
      story.passes = true;
      break;
    }

    // Failed - loop back with failure details
    attempts++;
  }

  if (attempts >= 5) {
    // Escalate
    console.log(`BLOCKED: ${story.id} failed after 5 attempts`);
  }
}
```

---

## Completion

When ALL stories have `passes: true`:

```bash
# Cleanup
node .claude/hooks/ralph-guard.js stop

# Final commit
git add -A && git commit -m "feat: Complete [feature name]"
```

Output:
```
TASK_COMPLETE

All stories implemented and validated:
- US-001: ✅
- US-002: ✅
- US-003: ✅

Total iterations: X
Total time: Y minutes
```

---

## Error Recovery

**If tdd-implementer fails repeatedly:**
1. Check AGENTS.md for similar patterns
2. Check test file for expected selectors/behavior
3. Simplify - implement minimum to pass tests
4. After 5 attempts, escalate with specific blocker

**If validators disagree:**
- Playwright PASS + Browser FAIL = UI renders but behavior broken
- Playwright FAIL + Browser PASS = Test expectations wrong (but tests are locked!)
- In this case, the IMPLEMENTATION must change, not tests

**If context runs out:**
1. Update STATE.md with current progress
2. Commit work so far
3. Close window, paste command in new window
4. Resume from STATE.md

---

## DO NOT

- Modify test files (hook will BLOCK with exit code 2)
- Skip validation (hook will BLOCK completion)
- Mark `passes: true` without all checkpoints
- Process dependent stories before dependencies complete
- Implement more than tests require
- Use old agent names (test-writer, builder, playwright-validator, browser-validator)
